<?xml version="1.0" encoding="UTF-8" ?>  
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.template.web.sys.mapper.SysRoleMapper">
	
	<sql id="sysRoleColumns">
		id,create_by,create_date,data_scope,del_flag,name,office_id,remarks,update_by,update_date
	</sql>
	
	<!-- 添加角色拥有的权限 -->
	<insert id="insertRoleResource">
		insert into sys_role_resource (role_id,resource_id) values
		<foreach collection="resourceIds" index="index" item="resourceId" separator=",">
			(#{id},#{resourceId,jdbcType=NUMERIC})
		</foreach>
	</insert>
	
	<!-- 添加角色所在机构 -->
	<insert id="insertRoleOffice">
		insert into sys_role_office (role_Id,office_id) values 
		<foreach collection="officeIds" index="index" item="officeId" separator=",">
			(#{id},#{officeId,jdbcType=NUMERIC})
		</foreach>
	</insert>
	
	<!-- 添加角色绑定的用户 -->
	<insert id="insertUserRole">
		insert into sys_user_role (role_Id,user_id) values 
		<foreach collection="userIds" index="index" item="userId" separator=",">
			(#{id},#{userId,jdbcType=NUMERIC})
		</foreach>
	</insert>
	
	<!-- 删除角色拥有的权限 -->
	<delete id="deleteRoleResourceByRoleId">
		delete from sys_role_resource where role_id = #{roleId}
	</delete>
	
	<!-- 删除角色所在的机构 -->
	<delete id="deleteRoleOfficeByRoleId">
		delete from sys_role_office where role_id = #{roleId}
	</delete>
	
	<!-- 删除角色所绑定的用户 -->
	<delete id="deleteUserRoleByRoleId">
		delete from sys_user_role where role_id = #{roleId}
	</delete>
	
	<!-- 根据角色id查询拥有的资源id集合 -->
	<select id="findResourceIdsByRoleId" resultType="java.lang.Long">
		select resource_id from sys_role_resource where role_id = #{roleId}
	</select>
	
	<!-- 根据角色id查询拥有的机构id集合 -->
	<select id="findOfficeIdsByRoleId" resultType="java.lang.Long">
		select office_id from sys_role_office where role_id = #{roleId}
	</select>
	
	<!-- 根据角色id查找用户 -->
	<select id="findUserByRoleId" resultType="com.template.web.sys.model.SysUser">
		select su.id,su.name from sys_user su left join sys_user_role sur 
		on su.id = sur.user_id 
		where sur.role_id = #{roleId} 
	</select>
	
	<!-- 根据角色id查询拥有的资源 -->
	<select id="findResourceByRoleId" resultType="com.template.web.sys.model.SysResource">
		select sr.id,sr.name from sys_resource sr left join sys_role_resource rr 
		on sr.id = rr.resource_id
		where role_id = #{roleId}
	</select>
	
	<!-- 分页查询角色 -->
	<select id="findPageInfo" resultType="com.template.web.sys.model.SysRole">
		select <include refid="sysRoleColumns"/> from sys_role
		<where>
			<if test="dataScope!=null and dataScope!=''">
				data_scope = #{dataScope}
			</if>
			<if test="name!=null and name!=''">
				and name like concat('%',#{name},'%')
			</if>
		</where>
		ORDER BY update_date desc
	</select>
	
</mapper>
